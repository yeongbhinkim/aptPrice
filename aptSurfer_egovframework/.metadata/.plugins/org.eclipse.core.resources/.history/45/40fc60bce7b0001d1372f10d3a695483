<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbvalley.premier.scm1.inbCreateReUp.mapper.InbCreateReUpMapper">

<select id="selectInbCreateReUplistL" parameterType="json"
		resultType="json">
		SELECT VBELN , LFDAT_LA
	      FROM(
	                SELECT SUBSTR(VBELN,1,10) VBELN ,LFDAT_LA
	                FROM TSCM_INB_DELIV_DISP_HISTORY  A
	                WHERE WERKS = #{WERKS} 
	                AND   LIFNR = #{LIFNR}
	                AND   TO_CHAR(LOGIN_YMD,'yyyy-mm-dd') BETWEEN #{LFDAT_LA} AND #{LFDAT_LA_TO}
	                AND   MATNR = NVL(#{MATNR},MATNR)
	                AND PRINT_YN = 'Y'
	                AND DELYN = 'N'
	                GROUP BY SUBSTR(VBELN,1,10), LFDAT_LA
	      )
	      ORDER BY VBELN DESC
	</select>
	<select id="selectInbCreateReUplistR" parameterType="json"
		resultType="json">
		SELECT  A.*, 
              (SELECT CD_NM  
              FROM TSCM_MLTCD 
              WHERE WERKS = #{WERKS}
              AND   CD = A.LGORT AND ROWNUM = 1) AS MLTNM, 
              GET_SUNG_YN(#{COMPANYCD},'100',A.LIFNR,A.MATNR,A.SEQNO, REPLACE(A.LFDAT_LA,'-','')) AS SUNG_YN,
              (SELECT COUNT(POSNR) FROM TSCM_INB_PUR_SPEC WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND LFDAT = A.LFDAT_LA AND MATNR = A.MATNR ) AS POSNR_CNT,
              (SELECT KCLOTNO FROM TSCM_PART_IDNTTY_LBL WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND MATNR = A.MATNR AND ROWNUM = 1) KCLOTNO,
              (SELECT REMARK FROM TSCM_PART_IDNTTY_LBL WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND MATNR = A.MATNR AND ROWNUM = 1) REMARK,
              TO_CHAR(TO_DATE(A.LFDAT_LA, 'YYYYMMDD'),'YYYY.MM.DD') AS LFDAT_LA_1,
              PREMIER_SYS.GETCMPYNMBYCMPYSN(#{COMPANYCD}) AS WERKS_NM, 
              (SELECT SUM(STOCK_QTY) FROM TSCM_INB_PUR_SPEC_STCQTY 
              WHERE SEQNO = #{SEQNO}
              AND   REPLACE(LFDAT,'-','') = A.LFDAT_LA
              AND   VBELN = A.VBELN
              AND   MATNR = A.MATNR
              AND   NVL(CHARG,'Z') = NVL(A.CHARG,NVL(CHARG,'Z'))
              ) AS STCQTY 
      FROM    TSCM_INB_DELIV_DISP_HISTORY A 
      WHERE   A.WERKS = #{WERKS}
      AND     A.VBELN = #{VBELN}
      AND     A.LGORT = DECODE(#{LGORT},'%',A.LGORT,LGORT)
      AND     A.LIFNR = #{LIFNR}
      AND     A.MATNR = NVL(#{MATNR},A.MATNR)
      AND     A.VBELN IS NOT NULL
      AND     A.DELYN = 'N'
      ORDER BY A.MATNR
	</select>
	
	<!-- 부품식별표 재발행  -->	                                
   	<update id="deleteLblTemp" parameterType="json">
  		DELETE FROM TSCM_PART_IDNTTY_LBL_TEMP
    	WHERE UPPER(LOGIN_ID) = UPPER(#{SYSID})  	
   	</update>
   	<insert id="insertLblTemp" parameterType="json">
   		INSERT INTO TSCM_PART_IDNTTY_LBL_TEMP(BARCO, WERKS, MATNR, SEQNO, ISDAT, LIFNR, MENGE, KZKRI, ITCAT, 
         PSEQNO, LGPBE, LIFNR_NM, CRDATE, LOTNO, KCLOTNO, REMARK, 
         LOGIN_YMD, LOGIN_ID, CHARG, II_DIV, MEINS, 
         BOX_CNT, BOX_CNT_IN, BOX_CNT_REM, SCM_VBELN, VBELN, NUM, SNO, QMS_SEQNO,
         GUIDENM )  
      SELECT  BARCO, WERKS, MATNR, SEQNO, ISDAT, LIFNR, MENGE, KZKRI, ITCAT, 
                          PSEQNO, LGPBE, LIFNR_NM, CRDATE, LOTNO, KCLOTNO, REMARK, 
                          SYSDATE, #{SYSID}, CHARG, II_DIV, MEINS, 
                          BOX_CNT, BOX_CNT_IN, BOX_CNT_REM, SCM_VBELN, VBELN, NUM, SNO, #{V_SEQNO},GUIDENM 
                  FROM   TSCM_PART_IDNTTY_LBL
                  WHERE  LIFNR = #{LIFNR}
                  AND    VBELN = #{VBELN}
                  AND    NVL(DELYN,'N') = 'N'
   	</insert>
   	
   	<!-- 수정  -->	                                
   	<update id="updateIdnttyLbl" parameterType="json">
   		 UPDATE TSCM_PART_IDNTTY_LBL
         SET    KCLOTNO = #{KCLOTNO},
                 REMARK = #{REMARK}
         WHERE  WERKS = #{WERKS}
         	AND    MATNR = #{MATNR}
         	AND    LIFNR = #{LIFNR}
         	AND    ISDAT = #{LFDAT_LA}
       		AND    VBELN = #{VBELN}
   	</update>
   	
 	<!-- 거래명세서 발행  -->	           
  	<update id="issueCnt" parameterType="json">
		UPDATE TSCM_INB_PUR_SPEC
		SET ISSUE_CNT = NVL(ISSUE_CNT,0) + 1
		WHERE LFDAT = #{LFDAT_LA}
			AND VBELN = #{VBELN}
			AND LIFNR = #{LIFNR}
    </update>
    <!-- 입하 삭제  이전에 posnr  -->	
    <select id="getPosnr" parameterType="json" resultType="json">
    	SELECT  POSNR, VBELN 
    	FROM  TSCM_INB_PUR_SPEC  
    	WHERE VBELN = #{VBELN}  AND  MATNR = #{MATNR}
    </select>    
    
	<!-- 입하 삭제  -->	
	<select id="getSapReturn" parameterType="json" resultType="json">
		 SELECT  MSG_TYP, MSG_TXT
	      FROM    SAP_TEST_RETURN
	      WHERE   SEQNO = #{SEQNO}
	      AND     PROC_NM='Z_MM_SCM_R_INB_PUR_SPEC_DEL'
	      AND     ROWNUM=1
	</select>
	<select id="selectMinPosnr" parameterType="json"
		resultType="json">
	 	SELECT  MIN(POSNR) AS POSNR_MIN
      	FROM    TSCM_INB_PUR_SPEC 
      	WHERE   VBELN = #{VBELN}
      	AND     MATNR = #{MATNR}
    </select>                    
	<update id="updatePurSpec" parameterType="json">
		UPDATE  TSCM_INB_PUR_SPEC
		     SET     DEL_DIV = 'Y', 
		             DEL_USERID = #{SYSID}, 
		             DEL_DATE = SYSDATE
		     WHERE   LIFNR = #{LIFNR}
		     AND     VBELN = #{VBELN} 
		     AND     MATNR = NVL(#{MATNR},MATNR)
	</update>
	
	<update id="updateDelivCreate" parameterType="json">
		UPDATE  TSCM_INB_DELIV_CREATE
              SET     FLAG = 'D'
              WHERE   LIFNR = #{LIFNR}
              AND     VBELN = #{VBELN}
              AND     MATNR = NVL(#{MATNR},MATNR)
	</update>
	
	<update id="updateDispHistory" parameterType="json">
		UPDATE  TSCM_INB_DELIV_DISP_HISTORY
		SET     DELYN = 'Y',
		        DEL_USERID = #{SYSID}, 
		        DEL_DATE = SYSDATE
		WHERE   LIFNR = #{LIFNR}
		AND		VBELN = #{VBELN}
        AND     MATNR = NVL(#{MATNR},MATNR)
	</update>
	
	<update id="setIdnttyLbl" parameterType="json">
		UPDATE TSCM_PART_IDNTTY_LBL
                SET DELYN = 'Y'
        WHERE   LIFNR = #{LIFNR}
     	AND		VBELN = #{VBELN}
        AND     MATNR = NVL(#{MATNR},MATNR)
	</update>
	
	<update id="delM1120" parameterType="json">
		DELETE FROM M_1120
        WHERE   LIFNR = #{LIFNR}
        AND     SCM_BARCO = #{VBELN}
        AND     MATNR = NVL(#{MATNR},MATNR)
	</update>
	
	<insert id="insertCancelIf" parameterType="json">
		INSERT INTO TSCM_PO_CANCEL_IF(IFKEY, IFYN, IFDATE, VBELN, POSNR, USERID, REGDAT)
        VALUES(SCM_PO_CANCEL_IF_SEQ.nextval,'N',NULL,#{VBELN},#{POSNR_MIN},#{SYSID}, SYSDATE)
	</insert>
	
	<update id="delArrivalLot" parameterType="json">
		DELETE  TSCM_ARRIVAL_LOT
		WHERE  LOTNO = #{VBELN}
	</update>
                        
</mapper>