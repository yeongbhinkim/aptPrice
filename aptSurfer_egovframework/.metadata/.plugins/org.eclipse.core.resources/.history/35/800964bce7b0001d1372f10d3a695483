<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbvalley.premier.scm1.rgstBarcoN.mapper.RgstBarcoNMapper">
	<select id="rgstBarcoNList" parameterType="json" resultType="json">
		SELECT A.*, ROWNUM RNO
	    FROM (
	 		SELECT  A.*, TO_CHAR(TO_DATE(ARRIVAL_TIME,'YY/MM/DD'),'YYYY.MM.DD') ARRIVAL_TIME_1, TO_CHAR(ARRIVAL_TIME,'YYYY.MM.DD HH24:MI:SS') ARRIVAL_TIME_2, 
	 		TO_CHAR(CREATE_DATE_,'YYYY.MM.DD HH24:MI:SS') CREATE_DATE_2, FLOOR(ROUND((CREATE_DATE_-ARRIVAL_TIME)*24*60*60)/86400) || 'Ïùº ' ||TO_CHAR(TO_DATE(CEIL(MOD(ROUND((CREATE_DATE_-ARRIVAL_TIME)*24*60*60),86400)),'SSSSS'),'HH24:MI:SS') V_MINUS_TIME,
	        PREMIER_SYS.GET_ITGR_MGT_CODE_NAME('0000004320',A.GUIDELINE,'',#{LANG}) GUIDENM
	        FROM(
	                SELECT A.WERKS, PREMIER_SYS.GETCMPYNMBYCMPYSN( DECODE(A.WERKS,'1110','11','1210','13','1220','13','31')) AS WERKSNM,
	                     A.LIFNR, PREMIER_SYS.GETCMPYNMBYCMPYSN_IF(A.LIFNR) LIFNRNM,  A.VBELN, A.MATNR, A.CHARG, A.ARRIVAL_TIME, 
	                     CASE WHEN A.CREATE_DATE_ IS NULL THEN NULL 
	                          WHEN A.CREATE_DATE_ <![CDATA[<]]>  A.ARRIVAL_TIME THEN A.ARRIVAL_TIME + 1/86440
	                          ELSE A.CREATE_DATE_
	                     END CREATE_DATE_,
	                     (CASE WHEN A.CREATE_DATE_ IS NULL THEN 'N' ELSE 'Y' END) ISCHECK,
	                     (SELECT GUIDELINE FROM TSCM_INB_DELIV_DISP_HISTORY WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND MATNR = A.MATNR AND ROWNUM = 1) AS GUIDELINE,
	                     (SELECT DELYN FROM TSCM_INB_DELIV_DISP_HISTORY WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND MATNR = A.MATNR AND ROWNUM = 1) AS DELYN
	                FROM(
	                    SELECT A.WERKS, PREMIER_SYS.GETCMPYNMBYCMPYSN( DECODE(A.WERKS,'1110','11','1210','13','1220','13','31')) AS WERKSNM,
	                           A.LIFNR, A.MATNR, A.CHARG, A.VBELN, MAX(A.ARRIVAL_TIME) ARRIVAL_TIME, MAX(A.CREATE_DATE_) AS CREATE_DATE_
	                    FROM(
	                          SELECT  A.WERKS, A.MATNR, A.CHARG, A.LIFNR, A.VBELN, A.POSNR,
	                                  (SELECT ARRIVAL_TIME FROM TSCM_ARRIVAL_LOT WHERE VENDCD = A.LIFNR AND LOTNO = A.VBELN AND ROWNUM = 1) AS ARRIVAL_TIME,
	                                  (SELECT CREATE_DATE_ FROM M_1120 WHERE MATNR = A.MATNR AND NVL(CHARG, '*') = NVL(A.CHARG, '*') AND ISDAT = A.LFDAT AND LIFNR = A.LIFNR AND SCM_BARCO = A.VBELN) AS CREATE_DATE_    
	                          FROM    TSCM_INB_PUR_SPEC A
	                          WHERE   EXISTS (SELECT 1 FROM TSCM_ARRIVAL_LOT WHERE LOTNO = A.VBELN)  
	                          ) A 
	                    GROUP BY A.WERKS, A.MATNR,  A.CHARG, A.LIFNR, A.VBELN
	              ) A    
	        ) A
	        WHERE 1=1
	        AND A.WERKS = NVL(#{WERKS},A.WERKS)
	        AND A.LIFNR = NVL(#{LIFNR},A.LIFNR)
	        AND A.VBELN LIKE '%'||#{VBELN}||'%'
	        AND TO_CHAR(A.ARRIVAL_TIME,'yyyymmdd') BETWEEN #{DATE} AND #{EDATE}
	        AND A.ISCHECK = NVL(#{ISCHECK},A.ISCHECK)
	        AND  EXISTS (SELECT 1 FROM TSCM_INB_DELIV_DISP_HISTORY WHERE VBELN = A.VBELN AND LIFNR = A.LIFNR AND MATNR = A.MATNR AND DELYN = NVL(#{DELYN},DELYN) )
	        ORDER BY A.ARRIVAL_TIME
		)A 
	</select>
        
</mapper>