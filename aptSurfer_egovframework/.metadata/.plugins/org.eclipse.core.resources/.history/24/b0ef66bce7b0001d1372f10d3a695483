<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbvalley.premier.temp.mapper.TempMapper">
	<!-- 현재시간 조회 -->
	<select id="selectTempDate" resultType="string">
		SELECT TO_CHAR(SYSDATE,'yyyy-MM-dd') FROM DUAL
	</select>
	
	<!-- 템플릿 테스트 목록 조회 -->
	<select id="selectTemplateList" parameterType="json" resultType="json">
		SELECT A.TEST_SEQ, A.PART_NO, A.PART_NM, A.MGT_ACC_NO, A.MGT_ACC_NM, A.BAD_CD, A.REMARK, A.CREATE_ACC_NO
			 , PREMIER_SYS.GET_ITGR_CODE_NAME(A.BAD_CD,#{LANG}) AS BAD_NM
			 , PREMIER_SYS.GETNAMEBYACCNO(A.CREATE_ACC_NO) AS CREATE_ACC_NM
			 , TO_CHAR(A.CREATE_DATE,'yyyy-MM-dd') CREAET_DATE
		  FROM TEMPLATE_TEST1 A
		 WHERE A.BAD_CD LIKE '%'||#{BAD_CD}||'%'
		   AND A.PART_NO LIKE '%'||#{PART_NO}||'%'
	</select>
	
	<!-- 템플릿 테스트 정보 조회 -->
	<select id="selectTemplateInfo" parameterType="json" resultType="json">
		SELECT A.*
		  FROM TEMPLATE_TEST1 A
		 WHERE TEST_SEQ = #{TEST_SEQ}
	</select>
	
	<!-- 템플릿 테스트 정보 저장 -->
	<update id="mergeTemplateInfo" parameterType="json">
		<selectKey resultType="Integer" keyProperty="TEST_SEQ" order="BEFORE">
			<choose>
				<when test="TEST_SEQ != null and TEST_SEQ != ''">
					SELECT #{TEST_SEQ} FROM DUAL
				</when>
				<otherwise>
					SELECT SEQ_TEST_SEQ.NEXTVAL FROM DUAL
				</otherwise>
			</choose> 
	    </selectKey> 
		MERGE INTO TEMPLATE_TEST1 A USING (
		SELECT #{TEST_SEQ} AS TEST_SEQ
		      ,#{PART_NO} AS PART_NO
		      ,#{PART_NM} AS PART_NM
		      ,#{MGT_ACC_NO} AS MGT_ACC_NO
		      ,#{MGT_ACC_NM} AS MGT_ACC_NM
		      ,#{BAD_CD} AS BAD_CD
		      ,#{REMARK} AS REMARK
		      ,#{ACC_NO} AS CREATE_ACC_NO
		      ,SYSDATE AS CREATE_DATE
		      ,#{ACC_NO} AS UPDATE_ACC_NO
		      ,SYSDATE AS UPDATE_DATE
		FROM DUAL ) D
		ON (A.TEST_SEQ = D.TEST_SEQ
		)
		WHEN MATCHED THEN
		  UPDATE SET A.PART_NO = D.PART_NO
		            ,A.PART_NM = D.PART_NM
		            ,A.MGT_ACC_NO = D.MGT_ACC_NO
		            ,A.MGT_ACC_NM = D.MGT_ACC_NM
		            ,A.BAD_CD = D.BAD_CD
		            ,A.REMARK = D.REMARK
		            ,A.CREATE_ACC_NO = D.CREATE_ACC_NO
		            ,A.CREATE_DATE = D.CREATE_DATE
		            ,A.UPDATE_ACC_NO = D.UPDATE_ACC_NO
		            ,A.UPDATE_DATE = D.UPDATE_DATE
		WHEN NOT MATCHED THEN
		INSERT(A.TEST_SEQ, A.PART_NO, A.PART_NM, A.MGT_ACC_NO, A.MGT_ACC_NM, A.BAD_CD, A.REMARK, A.CREATE_ACC_NO, A.CREATE_DATE, A.UPDATE_ACC_NO, A.UPDATE_DATE)
		VALUES(D.TEST_SEQ, D.PART_NO, D.PART_NM, D.MGT_ACC_NO, D.MGT_ACC_NM, D.BAD_CD, D.REMARK, D.CREATE_ACC_NO, D.CREATE_DATE, D.UPDATE_ACC_NO, D.UPDATE_DATE)
	</update>
	
	<!-- 템플릿 테스트 정보 삭제 -->
	<delete id="deleteTemplateInfo" parameterType="json">
		DELETE FROM TEMPLATE_TEST1 WHERE TEST_SEQ = #{TEST_SEQ}
	</delete>
</mapper>


