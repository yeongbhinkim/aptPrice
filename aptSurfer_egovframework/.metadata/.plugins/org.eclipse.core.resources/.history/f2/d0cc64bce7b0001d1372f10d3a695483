<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dbvalley.premier.scm1.subcontractList.mapper.SubcontractListMapper">
	<select id="subcontractList" parameterType="json" resultType="json">
       	SELECT A.*, ROWNUM RNO FROM
		(SELECT A.*, B.MAKTX, TO_CHAR(TO_DATE(A.BUDAT, 'yyyy-mm-dd'),'yyyy.mm.dd') BUDAT_1
        FROM  (
                   SELECT *
                    FROM (
                            SELECT MATBF, CHARG, TO_CHAR(TO_DATE(BUDAT, 'yyyy-mm-dd'),'yyyy.mm.dd') BUDAT,  STOCK_QTY, MEINS, MBLNR, MJAHR, ZEILE, 0 AS SORTNO
                            FROM TSCM_SUBCONTRACT_LIST
                            WHERE SEQNO = #{SEQNO}
                            AND NVL(MATBF,'*') like NVL('%'||#{MATNR}||'%','*') 
                            
                            UNION ALL
                            SELECT *
                            FROM (
                                    SELECT  NULL AS MATBF, NULL AS CHARG, TO_CHAR(TO_DATE(BUDAT, 'yyyy-mm-dd'),'yyyy.mm.dd') BUDAT,  ''||SUM(STOCK_QTY) AS STOCK_QTY,
                                           '일소계' AS MEINS, NULL AS MBLNR, NULL AS MJAHR, NULL AS ZEILE, 1 AS SORTNO
                                    FROM TSCM_SUBCONTRACT_LIST
                                    WHERE SEQNO = #{SEQNO}
                                    AND NVL(MATBF,'*') like NVL('%'||#{MATNR}||'%','*') 
                                    GROUP BY ROLLUP(BUDAT)
                                  )
                            WHERE BUDAT IS NOT NULL
                         ) ) A, TSCM_M_MATL_MST_IF B
        WHERE A.MATBF = B.MATNR(+)
            AND B.WERKS(+) = #{WERKS}
        ORDER BY A.BUDAT, A.SORTNO) A
	</select>
</mapper>